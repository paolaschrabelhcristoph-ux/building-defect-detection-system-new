<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>数据统计 - 建筑质量检测与缺陷识别系统</title>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg,
                #74b9ff 0%,
                #0984e3 25%,
                #6c5ce7 50%,
                #a29bfe 75%,
                #fd79a8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #636e72;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            color: #2d3436;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 180px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #636e72;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .apply-btn {
            background: linear-gradient(120deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #6c5ce7;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #5f4ae3;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>数据统计分析</h1>
        <p>建筑缺陷检测数据的可视化统计与分析</p>
    </div>

    <form action="/statistics" method="get" class="filters">
        <div class="filter-group">
            <label for="dateRange">时间范围</label>
            <select id="dateRange" name="dateRange">
                <option value="week" th:selected="${dateRange == 'week'}">最近一周</option>
                <option value="month" th:selected="${dateRange == 'month' || dateRange == null}">最近一个月</option>
                <option value="quarter" th:selected="${dateRange == 'quarter'}">最近一个季度</option>
                <option value="year" th:selected="${dateRange == 'year'}">最近一年</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="location">地区</label>
            <input type="text" id="location" name="location" th:value="${location}" placeholder="输入地区关键词">
        </div>
        <div class="filter-group">
            <label for="severity">危险程度</label>
            <select id="severity" name="severity">
                <option value="" th:selected="${severity == null}">全部</option>
                <option value="高" th:selected="${severity == '高'}">高</option>
                <option value="中" th:selected="${severity == '中'}">中</option>
                <option value="低" th:selected="${severity == '低'}">低</option>
            </select>
        </div>
        <button type="submit" class="apply-btn">应用筛选</button>
    </form>

    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number" th:text="${totalDefects}">128</div>
            <div class="stat-label">总缺陷数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${highRiskCount}">32</div>
            <div class="stat-label">高危缺陷</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${processedCount}">85</div>
            <div class="stat-label">已处理</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${unprocessedCount}">43</div>
            <div class="stat-label">待处理</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">缺陷类型分布</div>
        <div class="chart-wrapper">
            <canvas id="defectTypeChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">危险程度分布</div>
        <div class="chart-wrapper">
            <canvas id="severityChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">处理状态统计</div>
        <div class="chart-wrapper">
            <canvas id="processStatusChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">时间趋势分析</div>
        <div class="chart-wrapper">
            <canvas id="trendChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <div style="text-align: center;">
        <a href="/index" class="back-btn">返回首页</a>
    </div>
</div>

<script>
    // 页面加载完成后获取图表数据
    document.addEventListener('DOMContentLoaded', function() {
        loadChartData();
    });

    function loadChartData() {
        // 获取筛选参数
        const location = document.getElementById('location').value;
        const severity = document.getElementById('severity').value;

        console.log('Location:', location, 'Severity:', severity); // 调试信息

        // 构建请求URL
        let url = '/statistics/chart-data';
        const params = new URLSearchParams();
        if (location) params.append('location', location);
        if (severity) params.append('severity', severity);
        if (params.toString()) url += '?' + params.toString();

        console.log('Request URL:', url); // 调试信息

        fetch(url)
            .then(response => {
                console.log('Response status:', response.status); // 调试信息
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data); // 调试信息
                // 更新图表
                renderDefectTypeChart(data.defectTypeDistribution);
                renderSeverityChart(data.severityDistribution);
                renderProcessStatusChart(data.processedStatus);
                renderTrendChart(data.monthlyTrend);
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                // 显示错误信息
                alert('获取图表数据失败: ' + error.message);
            });
    }

    // 缺陷类型分布图表 - 柱状图
function renderDefectTypeChart(data) {
    const ctx = document.getElementById('defectTypeChart').getContext('2d');

    // 清除之前的图表
    if (window.defectTypeChart && typeof window.defectTypeChart.destroy === 'function') {
        window.defectTypeChart.destroy();
    }

    const labels = Object.keys(data);
    const values = Object.values(data);

    window.defectTypeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '缺陷数量',
                data: values,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '数量'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '缺陷类型'
                    }
                }
            }
        }
    });
}

// 危险程度分布图表 - 饼图
function renderSeverityChart(data) {
    const ctx = document.getElementById('severityChart').getContext('2d');

    // 清除之前的图表
    if (window.severityChart && typeof window.severityChart.destroy === 'function') {
        window.severityChart.destroy();
    }

    const labels = Object.keys(data);
    const values = Object.values(data);
    const colors = [
        'rgba(225, 112, 85, 0.7)',  // 高风险 - 红色
        'rgba(253, 203, 110, 0.7)', // 中风险 - 黄色
        'rgba(0, 184, 148, 0.7)'    // 低风险 - 绿色
    ];

    window.severityChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderColor: [
                    'rgba(225, 112, 85, 1)',
                    'rgba(253, 203, 110, 1)',
                    'rgba(0, 184, 148, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// 处理状态统计图表 - 柱状图
function renderProcessStatusChart(data) {
    const ctx = document.getElementById('processStatusChart').getContext('2d');

    // 清除之前的图表
    if (window.processStatusChart && typeof window.processStatusChart.destroy === 'function') {
        window.processStatusChart.destroy();
    }

    const labels = Object.keys(data);
    const values = Object.values(data);

    window.processStatusChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '处理状态数量',
                data: values,
                backgroundColor: [
                    'rgba(0, 184, 148, 0.7)',  // 已处理 - 绿色
                    'rgba(225, 112, 85, 0.7)'   // 未处理 - 红色
                ],
                borderColor: [
                    'rgba(0, 184, 148, 1)',
                    'rgba(225, 112, 85, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '数量'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '处理状态'
                    }
                }
            }
        }
    });
}

// 时间趋势分析图表 - 折线图
function renderTrendChart(data) {
    const ctx = document.getElementById('trendChart').getContext('2d');

    // 清除之前的图表
    if (window.trendChart && typeof window.trendChart.destroy === 'function') {
        window.trendChart.destroy();
    }

    const labels = Object.keys(data);
    const values = Object.values(data);

    window.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '缺陷数量',
                data: values,
                fill: false,
                borderColor: 'rgb(79, 172, 254)',
                tension: 0.1,
                backgroundColor: 'rgba(79, 172, 254, 0.2)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '数量'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '月份'
                    }
                }
            }
        }
    });
}


    // 监听筛选表单提交，重新加载图表
    document.querySelector('.filters').addEventListener('submit', function(e) {
        e.preventDefault();
        loadChartData();
    });
</script>


</body>
</html>
